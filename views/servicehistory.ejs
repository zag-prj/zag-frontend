<!DOCTYPE html>
<html lang="en">
<%- include("layout/head.ejs") %>
<link rel="stylesheet" href="/css/servicehistory.css">
<body>
  <!-- Include nav.ejs -->
  <%- include('layout/nav.ejs') %>

  <div class="container">
    <h1>Current Services</h1>
    <div id="current-services" class="current-services">
      <!-- Current requests will be injected here by servicehistory.js -->
    </div>

    <h1>Service History</h1>
    <div id="service-history" class="service-history">
      <!-- Service entries will be injected here by servicehistory.js -->
    </div>
  </div>

  <!-- Sample data for fallback -->
  <script>
    const sampleCurrentServices = [
      {
        clientId: '005',
        technicianId: 'Emily White',
        state: 'In Progress',
        requested: '2024-10-05T10:00:00Z',
        started: null,
        completed: null,
      },
      {
        clientId: '006',
        technicianId: 'Mark Taylor',
        state: 'Scheduled',
        requested: '2024-10-08T09:00:00Z',
        started: null,
        completed: null,
      }
    ];

    const sampleServiceHistory = [
      {
        clientId: '001',
        technicianId: 'John Doe',
        state: 'Completed',
        requested: '2024-07-15T08:30:00Z',
        started: '2024-07-15T09:00:00Z',
        completed: '2024-07-15T11:00:00Z',
      },
      {
        clientId: '002',
        technicianId: 'Jane Smith',
        state: 'Completed',
        requested: '2024-08-10T08:30:00Z',
        started: '2024-08-10T09:00:00Z',
        completed: '2024-08-10T10:00:00Z',
      },
      {
        clientId: '003',
        technicianId: 'Alan Brown',
        state: 'Completed',
        requested: '2024-09-05T08:30:00Z',
        started: '2024-09-05T09:00:00Z',
        completed: '2024-09-05T12:00:00Z',
      },
      {
        clientId: '004',
        technicianId: 'Assigned',
        state: 'Pending',
        requested: '2024-10-01T08:30:00Z',
        started: null,
        completed: null,
      }
    ];
  </script>

  <!-- Inline Script for Fetching and Displaying Data -->
  <script>
    async function fetchCurrentServices(clientId) {
      try {
        const response = await fetch(`/api/current-services/${clientId}`);
        if (response.ok) {
          const data = await response.json();
          displayCurrentServices(data);
        } else {
          console.error('Failed to fetch current services:', response.statusText);
          displayCurrentServices(sampleCurrentServices); // Use sample data
        }
      } catch (error) {
        console.error('Error fetching current services:', error);
        displayCurrentServices(sampleCurrentServices); // Use sample data
      }
    }

    function displayCurrentServices(data) {
      const container = document.getElementById('current-services');
      container.innerHTML = ''; // Clear existing content

      data.forEach(service => {
        const serviceElement = document.createElement('div');
        serviceElement.innerHTML = `
          <p>Job ID: ${service.clientId}</p>
          <p>Technician ID: ${service.technicianId}</p>
          <p>State: ${service.state}</p>
          <p>Requested: ${new Date(service.requested).toLocaleString()}</p>
          <p>Started: ${service.started ? new Date(service.started).toLocaleString() : 'N/A'}</p>
          <p>Completed: ${service.completed ? new Date(service.completed).toLocaleString() : 'N/A'}</p>
          <hr>
        `;
        container.appendChild(serviceElement);
      });
    }

    async function fetchServiceHistory(clientId) {
      try {
        const response = await fetch(`/api/service-history/${clientId}`);
        if (response.ok) {
          const data = await response.json();
          displayServiceHistory(data);
        } else {
          console.error('Failed to fetch service history:', response.statusText);
          displayServiceHistory(sampleServiceHistory); // Use sample data
        }
      } catch (error) {
        console.error('Error fetching service history:', error);
        displayServiceHistory(sampleServiceHistory); // Use sample data
      }
    }

    function displayServiceHistory(data) {
      const container = document.getElementById('service-history');
      container.innerHTML = ''; // Clear existing content

      data.forEach(job => {
        const jobElement = document.createElement('div');
        jobElement.innerHTML = `
          <p>Job ID: ${job.clientId}</p>
          <p>Technician ID: ${job.technicianId}</p>
          <p>State: ${job.state}</p>
          <p>Requested: ${new Date(job.requested).toLocaleString()}</p>
          <p>Started: ${job.started ? new Date(job.started).toLocaleString() : 'N/A'}</p>
          <p>Completed: ${job.completed ? new Date(job.completed).toLocaleString() : 'N/A'}</p>
          <hr>
        `;
        container.appendChild(jobElement);
      });
    }

    // Call fetch functions with the client ID from EJS
    const clientId = '<%= clientId %>'; // Injected client ID from server-side rendering
    fetchCurrentServices(clientId);
    fetchServiceHistory(clientId);
  </script>
</body>
</html>
